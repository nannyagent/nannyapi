# SBOM Vulnerability Scanning API

NannyAPI provides optional SBOM (Software Bill of Materials) vulnerability scanning capabilities powered by [Grype](https://github.com/anchore/grype). This feature allows agents to upload SBOMs generated by tools like [Syft](https://github.com/anchore/syft) and have them automatically scanned for known vulnerabilities.

## Table of Contents

- [Overview](#overview)
- [Scan Workflows](#scan-workflows)
- [Enabling Vulnerability Scanning](#enabling-vulnerability-scanning)
- [Agent Integration](#agent-integration)
- [API Endpoints](#api-endpoints)
- [Data Model](#data-model)
- [Security Considerations](#security-considerations)
- [Performance & Best Practices](#performance--best-practices)

## Overview

The SBOM vulnerability scanning feature provides:

- **SBOM Upload**: Agents can upload compressed SBOM files (tar.gz, zip, or plain JSON)
- **Automatic Scanning**: SBOMs are scanned using Grype vulnerability database
- **Rich Metadata**: CVSS scores, EPSS scores, fix availability, and related CVEs
- **Per-Agent Dashboards**: Vulnerability summaries aggregated by agent
- **Scheduled DB Updates**: Automatic grype database updates via cron
- **Efficient Storage**: Vulnerability data stored as archives, loaded on-demand
- **Automatic Retention**: Configurable per-agent scan retention limits
- **Per-Agent Syft Config**: Customizable exclusion patterns per agent

### Supported SBOM Formats

- **Syft JSON** (recommended)
- **CycloneDX JSON**
- **SPDX JSON**

### Storage Architecture

To prevent database bloat, vulnerability data is stored efficiently:

1. **Archive Storage**: Grype scan output is stored as `.tar.gz` files in `pb_data/storage/sbom_archives/{agent_id}/`
2. **Metadata Only in DB**: The `sbom_scans` collection stores only metadata (counts, timestamps, archive path)
3. **On-Demand Loading**: When vulnerabilities are requested, they're loaded from the archive
4. **Automatic Retention**: Old scans beyond the `scans_per_agent` limit (default: 10) are automatically deleted

This architecture ensures:
- Database size remains bounded regardless of scan volume
- Full vulnerability details remain accessible
- Archive files can be backed up or analyzed independently

## Scan Workflows

NannyAPI supports two distinct scanning workflows:

### 1. Client-Initiated Upload (Push Model)

The agent generates an SBOM and uploads it directly:

```
Agent                                      Server
  │                                          │
  │  1. Generate SBOM (syft)                 │
  │  2. Compress (tar.gz)                    │
  │  3. POST /api/sbom/upload ──────────────►│
  │                                          │  4. Extract & scan with Grype
  │                                          │  5. Store results
  │◄──────────────────────── Response ───────│
  │                                          │
```

**Use this when:** Agents run on a schedule and push SBOMs periodically.

### 2. Server-Initiated Scan (Pull Model)

The server requests a scan, and the agent responds:

```
User/Admin                Server                          Agent
    │                       │                               │
    │  1. Request scan      │                               │
    │   POST /api/sbom/request                              │
    │──────────────────────►│                               │
    │                       │  2. Status: pending           │
    │                       │                               │
    │                       │  3. Agent polls               │
    │                       │◄────GET /api/sbom/pending─────│
    │                       │                               │
    │                       │  4. Return scan request       │
    │                       │─────────────────────────────► │
    │                       │                               │
    │                       │  5. Acknowledge               │
    │                       │◄─POST /scans/{id}/acknowledge─│
    │                       │     Status: scanning          │
    │                       │                               │
    │                       │  6. Generate SBOM & scan      │
    │                       │  7. Upload results            │
    │                       │◄──POST /api/sbom/upload───────│
    │                       │                               │
    │                       │  8. Update status             │
    │                       │◄─PATCH /scans/{id}/status─────│
    │                       │     Status: completed         │
```

**Use this when:** Admins need on-demand scans or want centralized scan scheduling.

## Enabling Vulnerability Scanning

### Command Line

```bash
# Enable vulnerability scanning
./nannyapi serve --enable-vuln-scan

# With custom configuration
./nannyapi serve \
  --enable-vuln-scan \
  --grype-path=/usr/local/bin/grype \
  --grype-db-cache-dir=/var/cache/grype/db
```

### Environment Variables

If using the systemd service, edit `/var/lib/nannyapi/.env`:

```bash
# Enable vulnerability scanning
ENABLE_VULN_SCAN=true

# Optional: Custom grype binary path
# GRYPE_PATH=/usr/local/bin/grype

# Grype database cache directory
GRYPE_DB_CACHE_DIR=/var/cache/grype/db

# Cron expression for DB updates (default: daily at 3 AM)
GRYPE_DB_CRON="0 3 * * *"
```

### Docker

```bash
docker run -d \
  -e ENABLE_VULN_SCAN=true \
  -v grype-db:/var/cache/grype \
  -v pb-data:/app/pb_data \
  -p 8090:8090 \
  ghcr.io/nannyagent/nannyapi:latest
```

## Agent Integration

### Generating SBOMs with Syft

Install syft on the agent machine:

```bash
# Using install script
curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

# Or via package manager (if available)
brew install syft  # macOS
```

### Scanning the Host Filesystem

```bash
# Generate SBOM for the host filesystem
syft scan dir:/ -o json > sbom.json

# Compress for upload
gzip -c sbom.json > sbom.json.gz
```

### Scanning Containers

```bash
# Podman container
syft scan podman:my-container -o json > container-sbom.json

# Docker container
syft scan docker:my-container -o json > container-sbom.json

# Container image
syft scan registry.example.com/my-image:latest -o json > image-sbom.json
```

### Uploading to NannyAPI

```bash
# Using curl
curl -X POST "https://your-api.example.com/api/sbom/upload" \
  -H "Authorization: Bearer ${AGENT_TOKEN}" \
  -F "sbom_archive=@sbom.json.gz" \
  -F "scan_type=host" \
  -F "source_name=$(hostname)"

# For container scans
curl -X POST "https://your-api.example.com/api/sbom/upload" \
  -H "Authorization: Bearer ${AGENT_TOKEN}" \
  -F "sbom_archive=@container-sbom.json.gz" \
  -F "scan_type=container" \
  -F "source_name=my-container" \
  -F "source_type=podman"
```

### Example Agent Script

```bash
#!/bin/bash
# sbom-scan.sh - Run on agent machines via cron

set -euo pipefail

API_URL="${NANNYAPI_URL:-http://localhost:8090}"
AGENT_TOKEN="${NANNYAPI_AGENT_TOKEN}"

# Generate host SBOM
SBOM_FILE=$(mktemp /tmp/sbom.XXXXXX.json)
trap "rm -f ${SBOM_FILE} ${SBOM_FILE}.gz" EXIT

syft scan dir:/ -o json > "${SBOM_FILE}"
gzip -c "${SBOM_FILE}" > "${SBOM_FILE}.gz"

# Upload to API
curl -X POST "${API_URL}/api/sbom/upload" \
  -H "Authorization: Bearer ${AGENT_TOKEN}" \
  -F "sbom_archive=@${SBOM_FILE}.gz" \
  -F "scan_type=host" \
  -F "source_name=$(hostname)" \
  -w "\n"
```

Add to cron for daily scans:

```cron
0 4 * * * /usr/local/bin/sbom-scan.sh >> /var/log/sbom-scan.log 2>&1
```

## API Endpoints

### Check Scanner Status

```
GET /api/sbom/status
```

Returns the current status of the vulnerability scanning feature.

**Response:**
```json
{
  "enabled": true,
  "grype_version": "0.106.0",
  "db_version": "6.1.4",
  "db_built_at": "2025-01-29T01:31:21Z",
  "message": "Vulnerability scanning is active"
}
```

### Upload SBOM

```
POST /api/sbom/upload
Authorization: Bearer <token>
Content-Type: multipart/form-data
```

**Form Fields:**
- `sbom_archive` (required): The SBOM file (tar.gz, zip, or plain JSON)
- `scan_type` (optional): "host", "container", "image", or "directory"
- `source_name` (optional): Name of the scanned source (hostname, container name, etc.)
- `source_type` (optional): Source type (filesystem, podman, docker, etc.)

**Response:**
```json
{
  "scan_id": "abc123def456",
  "status": "completed",
  "message": "SBOM scanned successfully",
  "vuln_counts": {
    "critical": 2,
    "high": 15,
    "medium": 42,
    "low": 89,
    "negligible": 12,
    "unknown": 3,
    "total": 163
  }
}
```

### List Scans

```
GET /api/sbom/scans
Authorization: Bearer <token>
```

**Query Parameters:**
- `agent_id` (optional): Filter by agent ID
- `status` (optional): Filter by status (pending, scanning, completed, failed)
- `limit` (optional): Max results (default: 50, max: 100)
- `offset` (optional): Pagination offset

**Response:**
```json
{
  "scans": [
    {
      "scan_id": "abc123",
      "agent_id": "agent456",
      "scan_type": "host",
      "source_name": "server-01.example.com",
      "status": "completed",
      "total_packages": 1523,
      "critical_count": 2,
      "high_count": 15,
      "medium_count": 42,
      "low_count": 89,
      "scanned_at": "2025-01-29T12:00:00Z"
    }
  ],
  "total": 45,
  "limit": 50,
  "offset": 0
}
```

### Request Scan (Server-Initiated)

```
POST /api/sbom/request
Authorization: Bearer <user-token>
Content-Type: application/json
```

Users can request scans for their agents. The agent will pick up the pending scan request.

**Request Body:**
```json
{
  "agent_id": "agent456",
  "scan_type": "host",
  "source_name": "server-01.example.com",
  "source_type": "filesystem"
}
```

**Response:**
```json
{
  "scan_id": "abc123",
  "agent_id": "agent456",
  "scan_type": "host",
  "status": "pending",
  "source_name": "server-01.example.com",
  "source_type": "filesystem"
}
```

### Get Pending Scans (Agent)

```
GET /api/sbom/pending
Authorization: Bearer <agent-token>
```

Agents call this endpoint to get any pending scan requests assigned to them.

**Response:**
```json
{
  "scans": [
    {
      "scan_id": "abc123",
      "scan_type": "host",
      "source_name": "server-01.example.com",
      "source_type": "filesystem",
      "status": "pending"
    }
  ],
  "total": 1
}
```

### Acknowledge Scan (Agent)

```
POST /api/sbom/scans/{scanId}/acknowledge
Authorization: Bearer <agent-token>
```

Agent acknowledges that it has received and is starting a scan request. This updates the status to "scanning".

**Response:**
```json
{
  "success": true,
  "scan_id": "abc123",
  "status": "scanning"
}
```

### Update Scan Status (Agent)

```
PATCH /api/sbom/scans/{scanId}/status
Authorization: Bearer <agent-token>
Content-Type: application/json
```

Agent updates the scan status (e.g., to "completed" or "failed").

**Request Body:**
```json
{
  "status": "completed",
  "error_message": ""
}
```

**Response:**
```json
{
  "success": true,
  "scan_id": "abc123",
  "status": "completed"
}
```

### Get Scan Details

```
GET /api/sbom/scans/{scanId}
Authorization: Bearer <token>
```

### Get Scan Vulnerabilities

```
GET /api/sbom/scans/{scanId}/vulnerabilities
Authorization: Bearer <token>
```

**Query Parameters:**
- `severity` (optional): Filter by severity (critical, high, medium, low, negligible, unknown)
- `fixable` (optional): Set to "true" to show only fixable vulnerabilities
- `limit` (optional): Max results (default: 100, max: 500)
- `offset` (optional): Pagination offset

**Response:**
```json
{
  "vulnerabilities": [
    {
      "id": "vuln123",
      "vulnerability_id": "CVE-2024-12345",
      "severity": "critical",
      "package_name": "openssl",
      "package_version": "1.1.1k",
      "package_type": "rpm",
      "fix_state": "fixed",
      "fix_versions": ["1.1.1n", "3.0.7"],
      "description": "Buffer overflow vulnerability in...",
      "cvss_score": 9.8,
      "cvss_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
      "epss_score": 0.00152,
      "epss_percentile": 0.5234,
      "related_cves": ["CVE-2024-12346"]
    }
  ],
  "total": 163,
  "limit": 100,
  "offset": 0
}
```

### Get Agent Vulnerability Summary

```
GET /api/sbom/agents/{agentId}/summary
Authorization: Bearer <token>
```

**Response:**
```json
{
  "agent_id": "agent456",
  "total_scans": 30,
  "total_vulnerabilities": 163,
  "critical_count": 2,
  "high_count": 15,
  "medium_count": 42,
  "low_count": 89,
  "fixable_count": 95,
  "last_scan_at": "2025-01-29T12:00:00Z",
  "last_scan_id": "abc123"
}
```

### Get All Agent Vulnerabilities

```
GET /api/sbom/agents/{agentId}/vulnerabilities
Authorization: Bearer <token>
```

Returns all vulnerabilities across all scans for an agent.

### Get Agent Syft Configuration

```
GET /api/sbom/agents/{agentId}/syft-config
Authorization: Bearer <user-token>
```

**Or for agents getting their own config:**
```
GET /api/sbom/config/syft
Authorization: Bearer <agent-token>
```

Returns the syft exclusion patterns configured for the agent. If no agent-specific patterns are set, returns the default patterns from `sbom_settings`.

**Response:**
```json
{
  "exclude_patterns": [
    "**/proc/**",
    "**/sys/**",
    "**/dev/**",
    "**/run/**",
    "**/tmp/**",
    "**/var/cache/**",
    "**/var/log/**",
    "**/home/*/.cache/**"
  ]
}
```

### Update Agent Syft Configuration

```
PUT /api/sbom/agents/{agentId}/syft-config
Authorization: Bearer <user-token>
Content-Type: application/json
```

Users can set custom syft exclusion patterns for their agents. Agents cannot update their own configuration.

**Request Body:**
```json
{
  "exclude_patterns": [
    "**/proc/**",
    "**/sys/**",
    "**/dev/**",
    "**/run/**",
    "**/tmp/**",
    "**/var/cache/**",
    "**/var/log/**",
    "**/home/*/.cache/**",
    "**/opt/backups/**"
  ]
}
```

**Response:**
```json
{
  "success": true,
  "agent_id": "agent456",
  "exclude_patterns": ["**/proc/**", "..."]
}
```

### Trigger Database Update (Admin Only)

```
POST /api/sbom/db/update
Authorization: Bearer <admin-token>
```

Triggers an immediate update of the Grype vulnerability database.

## Data Model

### Scan Types

| Type | Description |
|------|-------------|
| `host` | Full host filesystem scan |
| `container` | Running container scan |
| `image` | Container image scan |
| `directory` | Specific directory scan |

### Scan Statuses

| Status | Description |
|--------|-------------|
| `pending` | Scan queued |
| `scanning` | Scan in progress |
| `completed` | Scan finished successfully |
| `failed` | Scan failed (see error_message) |

### Severity Levels

| Severity | Description |
|----------|-------------|
| `critical` | CVSS 9.0-10.0 |
| `high` | CVSS 7.0-8.9 |
| `medium` | CVSS 4.0-6.9 |
| `low` | CVSS 0.1-3.9 |
| `negligible` | CVSS 0.0 or informational |
| `unknown` | No CVSS score available |

### Fix States

| State | Description |
|-------|-------------|
| `fixed` | Fix available, upgrade recommended |
| `not-fixed` | No fix currently available |
| `wont-fix` | Vendor will not fix |
| `unknown` | Fix status unknown |

## Security Considerations

### Archive Security

- Maximum archive size: **50 MB**
- Maximum extracted size: **100 MB**
- Path traversal protection enabled
- Only `.json`, `.xml`, `.spdx`, `.cdx` files extracted
- Archives deleted immediately after processing

### Access Control

- SBOM upload requires authentication
- Agents can only access their own scans
- Users can only access scans from their agents
- DB update endpoint requires admin privileges

### Data Privacy

- SBOMs are processed and deleted immediately (not stored)
- Grype scan output stored as archives (not in database)
- Only scan metadata (counts, timestamps) in database
- Automatic retention limit: configurable scans per agent (default: 10)
- Archive files can be deleted manually if needed

## Performance & Best Practices

### Recommended Scan Frequency

- **Host systems**: Daily scans
- **Production containers**: After each deployment
- **Development environments**: Weekly scans

### Optimizing Scan Size

Exclusion patterns can be configured per-agent via the API:

```bash
# Get agent's configured exclusion patterns
PATTERNS=$(curl -s "${NANNYAPI_URL}/api/sbom/config/syft" \
  -H "Authorization: Bearer ${AGENT_TOKEN}" | jq -r '.exclude_patterns[]')

# Build syft command with exclusions
EXCLUDE_ARGS=""
for pattern in $PATTERNS; do
    EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude '$pattern'"
done

# Run syft with configured exclusions
eval "syft scan dir:/ $EXCLUDE_ARGS -o json > sbom.json"
```

Users can customize exclusions for each agent:

```bash
# Set custom patterns for an agent
curl -X PUT "${NANNYAPI_URL}/api/sbom/agents/${AGENT_ID}/syft-config" \
  -H "Authorization: Bearer ${USER_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "exclude_patterns": [
      "**/proc/**",
      "**/sys/**",
      "**/dev/**",
      "**/opt/large-app/cache/**"
    ]
  }'
```

### Database Updates

The Grype vulnerability database is updated automatically based on the cron schedule (default: daily at 3 AM). For environments requiring fresher data:

```bash
# Manual update via API
curl -X POST "https://your-api.example.com/api/sbom/db/update" \
  -H "Authorization: Bearer ${ADMIN_TOKEN}"
```

### High-Volume Environments

For environments with many agents, consider:

1. **Stagger scan times**: Don't run all agents at the same time
2. **Use compression**: Always gzip SBOM files before upload
3. **Incremental scans**: Use syft's caching capabilities
4. **Separate grype DB volume**: Use a shared volume for the database cache

## Troubleshooting

### Scanner Not Enabled

```json
{"enabled": false, "message": "Vulnerability scanning is not enabled..."}
```

Solution: Add `--enable-vuln-scan` flag or set `ENABLE_VULN_SCAN=true`.

### Grype Not Found

```
grype is not installed or not in PATH
```

Solution: Install grype or set `--grype-path` to the correct binary location.

### Database Not Valid

```
Grype vulnerability database is invalid or not available
```

Solution: Run `grype db update` or trigger update via API.

### Large SBOM Rejected

```
archive exceeds maximum size limit
```

Solution: Compress the SBOM with gzip or exclude unnecessary directories from the scan.
